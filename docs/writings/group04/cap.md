# CAP定理

CAP定理又称CAP原则，指的是在一个分布式系统中，Consistency（一致性）、 Availability（可用性）、Partition tolerance（分区容错性），最多只能同时拥有三个特性中的两个，三者不可兼得。

# 何为CAP
### Consistency (一致性)
“all nodes see the same data at the same time”,即更新操作成功并返回客户端后，所有节点在同一时间的数据完全一致，这就是分布式的一致性。一致性的问题在并发系统中不可避免，对于客户端来说，一致性指的是并发访问时更新过的数据如何获取的问题。从服务端来看，则是更新如何复制分布到整个系统，以保证数据最终一致。

### Availability (可用性)
可用性指“Reads and writes always succeed”，即服务一直可用，而且是正常响应时间。好的可用性主要是指系统能够很好的为用户服务，不出现用户操作失败或者访问超时等用户体验不好的情况。

### Partition Tolerance (分区容错性)
即分布式系统在遇到某节点或网络分区故障的时候，仍然能够对外提供满足一致性和可用性的服务。分区容错性要求能够使应用虽然是一个分布式系统，而看上去却好像是在一个可以运转正常的整体。比如现在的分布式系统中有某一个或者几个机器宕掉了，其他剩下的机器还能够正常运转满足系统需求，对于用户而言并没有什么体验上的影响。

# CAP简要说明
现在有一个简单的分布式系统，由两个节点：NodeA和NodeB组成。用户ClientA连接NodeA，更新了数据，NodeA将数据同步给NodeB。另外一个用户ClientB连接NodeB，读取数据，此时数据是最新的。假设NodeA挂了，停止服务，那么ClientB会连接到NodeB，整个系统依然正常工作。系统满足Partition Tolerance (P).

现在假设ClientA更细的NodeA，NodeA准备将数据同步给NodeB，发现与NodeB连接不上了，同步失败。此时，ClientB连接了NodeB，正好读取ClientA已经修改的数据。如果NodeB返回数据，那么这个数据不是最新的，这种情况下，系统满足了Availability (A)，但是不满足Consistency (C)。如果NodeB此刻拒绝服务，知道NodeA的同步完成后，再返回ClientB数据，这种情况下，系统满足了Consistency (C)，但是不满足Availability (A)。

因此，一个分布式系统是不能同时满足C,A,P的。

# CAP取舍
因为CAP不能同时满足，由此产生了三种策略：CA, CP和AP

- 满足CA, 放弃分区容错性 (P)，系统由单一节点组成，那就不是分布式了，这种系统的脆弱的，难以扩展的。
- 满足CP, 放弃可用性 (A)，系统在节点同步的时候无法使用，降低了某些时段的用户体验。
- 满足AP, 放弃一致性 (C), 系统在某些时段内，部分用户的访问数据是过期的。

当今绝大多数大型应用都是分布式的，不同的应用场景采取不同的分布式策略。
