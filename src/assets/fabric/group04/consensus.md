# 咖啡馆的区块链之旅
自从咖啡馆营业以来，小明日夜奋斗，研发出口味独特的咖啡，且待客热情，如今客似云来，生意红红火火。

咖啡馆营业至深夜两点。每天打烊后，小明坐在电脑旁边，看看账单，算算利润，白天的苦和累，渐渐消失，转化成明天的动力。

半年之后，小明在城东新开了一家分店，由女友小红打理。很快，小红的店也火起来了，成为了城中年轻人最喜欢聚头的地点之一。

今天是国庆黄金周，小明的店迎来了开业以来最大的客流量。忙得不可开交之时，账单系统奔溃了，客人无法支付......重启、修复、设置，大概过了一个小时，系统重新运行。客户纷纷抱怨、离去。小明心里苦啊！

## 容错
深夜打烊后，小明坐在电脑旁边，表情严肃。计算机专业毕业的小明，已经有了一套新的方案，他决定使用3台电脑同时记账，其中一台电脑发生故障不会导致整个记账系统不可用。

国庆黄金周期间，再也没有出现客户无法支付的情况，小明长长地舒了一口气。只是，每天晚上，要把3台电脑的数据重新汇总，统计，略微麻烦。

## Raft
又过了半年，小明在城西新开一家分店，由弟弟小朋打理。小朋不负哥哥期望，生意做的有声有色。

这天晚上，小明坐在电脑旁边，表情严肃。现在账单越来越多，3台电脑的数据汇总耗时越来越长，如此下去，终究是个麻烦。小明打开google搜索，突然眼前一亮，Raft共识算法，不正式我要找的吗！

于是，小明重新设计了账单系统：
1. 3台电脑各自运行一个记账节点
2. 起初，从中选取一个节点记账，同时广播给其他节点
3. 非选中节点只接收当选者的广播，不处理客户发起的请求
4. 如果当选节点发生故障，重新选举

如此，账单在3台电脑总是保持一致，同时整个系统不会因单一节点故障导致不可用。小明再也不用熬夜汇总，日子好过多了。

## 加盟者
小明参加同学聚会。大伙都对小明赞不绝口，简直是经商奇才。同学小龙和小虎表示要加盟，把生意做大做强，小明想都没想就同意了。

小龙和小虎分别在城西和城北开了分店，各自跑一个账单系统节点，这样，整个账单系统一共有5各节点运行。小明的咖啡馆品牌在城中知名度越来越高，应酬也越来越多，店里的事，大多都交给小红和小朋打理。

月底，小明拿到了上个月的账本报告，觉得有点地方不对劲。按理，新开了分店，但是入账并没有成比例地上涨，倒是成本成比例地上涨，到底是哪里出了问题呢？

整个周末，小明都没有离开家门，反复地查账，得出一个结论：有人做假账了。当前账单系统有5个节点运行，同一时间处理客户订单的只有一个节点，必定是当中的某个节点出猫，当出猫节点当选时，瞒报了账单数目！

## POW
又是一连几天的google搜索，小明发现账本系统遇到的问题正是拜占庭容错算法可以解决的，而当中的佼佼者，是比特币所使用的POW算法。于是小明重新设计了账本系统：
1. 5个节点各自独立处理订单，不再选举
2. 订单生成，在5个节点当中广播
3. 节点接收订单，打包区块，计算哈希值，生成区块，广播区块
4. 节点接收区块，验证哈希值，存储区块
5. 节点当中最长的链，就是5个节点都认可的主链

现在，假若有节点想修改过往的数据，必须重新计算该区块的哈希值，以及后面区块的哈希值，这需要花费很长的时间，它的链就不是最长的，修改的数据也不会被认可；假若节点在收到订单的时候修改数据，那么它的区块将与其他区块冲突，经过一段时间后，造假区块将被其他节点丢弃。

小明现在要确保的是，账单系统的绝大部分节点掌握在自己手中，即可杜绝做假账的事情了。

## POS
这一天，小明外出采购，经过小红的店，就和小红聊起来了。小红说到，自从用了新的账本系统，电费猛涨，夏天用电量高峰时期，部分大功率的电器跑不起来，不知道是怎么个回事。

晚上，小明坐在电脑旁边，又想起了小红的话。其实，小明也早已发现这个问题了。于是，打开google搜索，一个新的idear生成。小明重新设计了账本系统:
1. 打包区块不需要每个节点都跑，愿意跑的出一笔准备金，准备金越高，获得打包的机会越大
2. 打包之后，准备金最高的前3个节点进行验证、投票，决定是否认可区块
3. 投票通过后，区块广播，写入账本之中

如此一来，大大地减少了计算消耗。若是发现造假，投票人决绝投票，同时没收它的准备金，从而保证了安全。

新的账本系统推出后，大伙都很满意。